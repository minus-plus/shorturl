<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TinyURL</title>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-route.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-resource.min.js"></script>
        <script src="/node_modules/chart.js/dist/Chart.min.js"></script>
        <script src="/node_modules/angular-chart.js/dist/angular-chart.min.js"></script>


        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    </head>
    
    <body ng-app="tinyurlApp">
        <header>
            <div class="container">
                <nav class="navbar navbar-default">
                    <div class="navbar-header">
                    <!-- there is a link here, use $routeProvide to routing-->
                        <a class="navbar-brand" href="#/">TinyURL</a>
                    </div>
                </nav>
            </div>
        </header>

        <div class="container">
            <div ng-view></div>
        </div>
        <script type="text/javascript">
        	// call api to get data
        	var app = angular.module('tinyurlApp',['ngRoute', 'ngResource', 'chart.js']);
        	app.config(function($routeProvider) {
        		//dependencies injection, call for routeProvider object
        		$routeProvider.when('/', {
        			// set template and controller
        			templateUrl: '/public/views/get_tinyUrl.html',
        			controller: 'homeController'
        		}).when('/urls/:shortUrl', {
                    templateUrl: '/public/views/url.html',
                    controller: 'urlController'
                })
        	});
        	app.controller('homeController', function($scope, $http, $location) {
        		$scope.submit = function() {
        			$http.post('api/v1/urls', {
        				longUrl: $scope.longUrl,
        			}).success(function(data) {
        				$location.path('/urls/' + data.shortUrl);
        				console.log('success');
        			});
        		};
        	});

            app.controller('urlController', function($scope, $http, $routeParams) {
                // get information from api
                $http.get('/api/v1/urls/' + $routeParams.shortUrl).success(function(data) {
                    // fill the data to the scope
                    $scope.longUrl = data.longUrl;
                    $scope.shortUrl = data.shortUrl;
                    $scope.shortUrlToShow = 'http://location:4000/' + data.shortUrl;
                });
                // deal with api/urls/:shorturl/:info
                $http.get('/api/v1/urls/' + $routeParams.shortUrl + '/totalClicks').success(function(data) {
                    $scope.totalClicks = data;
                });
                var renderChart = function (chart, infos) {
                    console.log(infos);
                    $scope[chart + "Labels"] = [];
                    $scope[chart + "Data"] = [];
                    $http.get("/api/v1/urls/" + $routeParams.shortUrl + "/" + infos)
                        .success(function (data) {
                            data.forEach(function (info) {
                                $scope[chart + "Labels"].push(info._id);
                                $scope[chart + "Data"].push(info.count);
                            });
                        });
                };
                renderChart("doughnut", "referer");
                renderChart("pie", "country");
                renderChart("base", "platform");
                renderChart("bar", "browser");

                $scope.hour = "hour";
                $scope.day = "day";
                $scope.month = "month";
                $scope.time = $scope.hour;

                $scope.getTime = function (time) {
                    $scope.lineLabels = [];
                    $scope.lineData = [];

                    $scope.time = time;

                    $http.get("/api/v1/urls/" + $routeParams.shortUrl + "/" + time)
                        .success(function (data) {
                            data.forEach(function (item) {
                                var legend = "";
                                if (time === "hour") {
                                    if (item._id.minutes < 10) {
                                        item._id.minutes = "0" + item._id.minutes;
                                    }
                                    legend = item._id.hour + ":" + item._id.minutes;
                                }
                                if (time === "day") {
                                    legend = item._id.hour + ":00";
                                }
                                if (time === "month") {
                                    legend = item._id.month + "/" + item._id.day;
                                }
                                $scope.lineLabels.push(legend);
                                $scope.lineData.push(item.count);
                            });
                            console.log($scope.lineLabels);
                            console.log($scope.lineData);
                        });
                };

                $scope.getTime($scope.time);

            });


        </script>
    </body>
</html>